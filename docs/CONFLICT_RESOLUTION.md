# 帳號矩陣與權限衝突決策機制

本文檔說明當多位管理員同時操作，或在不同模組（團隊管理 vs 矩陣管理）進行帳號指派時的系統決策邏輯。

## 1. 核心原則：最後操作優先 (Last Writer Wins)

本系統採用「最後操作優先」原則處理大部分的指派衝突。這意味著如果帳號 A 原本屬於員工甲，管理員將其指派給員工乙，系統將立即執行變更，員工甲將失去對該帳號的管理權限。

## 2. 衝突情境與決策表

| 情境 | 動作 A | 動作 B | 系統決策結果 | 備註 |
| :--- | :--- | :--- | :--- | :--- |
| **重複指派** | 管理員 X 指派帳號 A 給員工甲 | 管理員 Y 指派帳號 A 給員工乙 | **帳號 A 歸屬員工乙** | 以時間戳記較晚的操作為準 |
| **刪除與指派** | 管理員 X 正在編輯帳號 A | 管理員 Y 刪除了帳號 A | **操作失敗** | 管理員 X 儲存時會收到「帳號不存在」錯誤 |
| **離職處理** | 員工甲被標記為離職/刪除 | 帳號 A 仍指派給員工甲 | **帳號 A 變為「未指派」** | 刪除員工時，系統自動釋放其名下資產 |
| **封禁帳號指派** | 帳號 A 狀態變為「封禁」 | 管理員嘗試指派帳號 A | **允許指派** | 封禁帳號仍需有人負責處理申訴，故允許指派 |
| **批量操作衝突** | 批量指派 10 個帳號 | 其中 1 個帳號剛被刪除 | **部分成功** | 存在的 9 個帳號指派成功，回報 1 個失敗 |

## 3. 權限繼承規則

- **管理員 (Admin)**：擁有最高權限，可檢視並指派所有帳號。
- **組長 (Team Leader)**：僅可檢視並指派其下屬員工的帳號（目前系統簡化為可見所有 Staff，但未來可擴充 RBAC）。
- **員工 (Staff)**：僅可檢視自己被指派的帳號，不可進行指派操作。

## 4. 資料一致性保障

為了確保「成員列表視圖」與「資源矩陣視圖」的資料一致性：
1. **前端同步**：兩個視圖共享同一份後端數據源。切換 Tab 時會觸發重新抓取 (Refetch) 或共享狀態更新。
2. **即時性**：雖然不使用 WebSocket，但每次操作（指派、編輯）成功後，前端會自動刷新列表。

## 5. 建議操作規範

為減少衝突，建議：
1. 在進行大規模批量指派前，先在群組內告知其他管理員。
2. 定期清理「未指派」的閒置帳號。
3. 若帳號發生異常（如驗證失敗），優先指派給資深員工 (Specialist) 處理。
